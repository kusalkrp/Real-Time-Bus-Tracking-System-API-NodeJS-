# NTC Bus Tracking System - Complete Dataset Summary

## Routes (5 Total)

| Route | From | To | Distance (km) | Time (hrs) | Segments |
|-------|------|----|--------------:|------------|----------|
| 01 | Colombo | Kandy | 116 | 4.17 | Colombo-Peradeniya (80km, 1.67h), Peradeniya-Kadugannawa (20km, 1h), Kadugannawa-Kandy (16km, 1.5h) |
| 02 | Colombo | Matara | 162 | 4.5 | Colombo-Galle (116km, 3h), Galle-Matara (46km, 1.5h) |
| 04 | Colombo | Puttalam | 132 | 4.0 | Colombo-Chilaw (80km, 2.5h), Chilaw-Puttalam (52km, 1.5h) |
| 08 | Colombo | Matale | 141.3 | 4.0 | Colombo-Peradeniya (80km, 1.25h), Peradeniya-Kadugannawa (15km, 0.55h), Kadugannawa-Mawanela (15km, 0.55h), Mawanela-Matale (20km, 0.95h) |
| 15 | Colombo | Anuradhapura | 200 | 5.0 | Colombo-Kurunegala (93km, 2.5h), Kurunegala-Anuradhapura (107km, 2.5h) |

## Buses (25 Total - 5 per Route)

### Route 01 (Colombo-Kandy) - 5 Buses
| Bus ID | Plate No | Permit | Operator | Operator Type | Bus Type | Capacity | Service |
|--------|----------|--------|----------|---------------|----------|----------|---------|
| BUS001 | NB-1234 | NTC2023001 | SLTB01 | SLTB | AC Luxury | 50 | LU |
| BUS002 | NB-5678 | NTC2023002 | SLTB01 | SLTB | Semi-Luxury | 45 | SE |
| BUS003 | NB-9012 | NTC2023003 | SLTB01 | SLTB | Normal | 60 | N |
| BUS004 | WP-3456 | NTC2023004 | PVT01 | Private | AC Luxury | 55 | LU |
| BUS005 | CP-7890 | NTC2023005 | PVT01 | Private | Semi-Luxury | 48 | SE |

### Route 02 (Colombo-Matara) - 5 Buses
| Bus ID | Plate No | Permit | Operator | Operator Type | Bus Type | Capacity | Service |
|--------|----------|--------|----------|---------------|----------|----------|---------|
| BUS006 | SP-2341 | NTC2023006 | SLTB02 | SLTB | AC Luxury | 52 | LU |
| BUS007 | SP-6785 | NTC2023007 | SLTB02 | SLTB | Normal | 58 | N |
| BUS008 | SP-1029 | NTC2023008 | PVT02 | Private | Semi-Luxury | 46 | SE |
| BUS009 | GA-4567 | NTC2023009 | PVT02 | Private | AC Luxury | 50 | LU |
| BUS010 | GA-8901 | NTC2023010 | SLTB02 | SLTB | Normal | 62 | N |

### Route 04 (Colombo-Puttalam) - 5 Buses
| Bus ID | Plate No | Permit | Operator | Operator Type | Bus Type | Capacity | Service |
|--------|----------|--------|----------|---------------|----------|----------|---------|
| BUS011 | WP-2345 | NTC2023011 | SLTB03 | SLTB | Semi-Luxury | 48 | SE |
| BUS012 | WP-6789 | NTC2023012 | SLTB03 | SLTB | Normal | 55 | N |
| BUS013 | PT-1234 | NTC2023013 | PVT03 | Private | AC Luxury | 44 | LU |
| BUS014 | PT-5678 | NTC2023014 | PVT03 | Private | Semi-Luxury | 50 | SE |
| BUS015 | CH-9012 | NTC2023015 | SLTB03 | SLTB | Normal | 60 | N |

### Route 08 (Colombo-Matale) - 5 Buses
| Bus ID | Plate No | Permit | Operator | Operator Type | Bus Type | Capacity | Service |
|--------|----------|--------|----------|---------------|----------|----------|---------|
| BUS016 | KE-3456 | NTC2023016 | SLTB04 | SLTB | AC Luxury | 47 | LU |
| BUS017 | KE-7890 | NTC2023017 | SLTB04 | SLTB | Normal | 56 | N |
| BUS018 | ML-1234 | NTC2023018 | PVT04 | Private | Semi-Luxury | 42 | SE |
| BUS019 | ML-5678 | NTC2023019 | PVT04 | Private | AC Luxury | 49 | LU |
| BUS020 | DM-9012 | NTC2023020 | SLTB04 | SLTB | Normal | 58 | N |

### Route 15 (Colombo-Anuradhapura) - 5 Buses
| Bus ID | Plate No | Permit | Operator | Operator Type | Bus Type | Capacity | Service |
|--------|----------|--------|----------|---------------|----------|----------|---------|
| BUS021 | KU-2345 | NTC2023021 | SLTB05 | SLTB | AC Luxury | 51 | LU |
| BUS022 | KU-6789 | NTC2023022 | SLTB05 | SLTB | Normal | 59 | N |
| BUS023 | AD-1234 | NTC2023023 | PVT05 | Private | Semi-Luxury | 45 | SE |
| BUS024 | AD-5678 | NTC2023024 | PVT05 | Private | AC Luxury | 53 | LU |
| BUS025 | NC-9012 | NTC2023025 | SLTB05 | SLTB | Normal | 61 | N |

## Operators (10 Total)

### SLTB Operators (5)
| Operator ID | Email | Routes Covered |
|-------------|-------|----------------|
| SLTB01 | sltb01@sltb.lk | Route 01 (Colombo-Kandy) |
| SLTB02 | sltb02@sltb.lk | Route 02 (Colombo-Matara) |
| SLTB03 | sltb03@sltb.lk | Route 04 (Colombo-Puttalam) |
| SLTB04 | sltb04@sltb.lk | Route 08 (Colombo-Matale) |
| SLTB05 | sltb05@sltb.lk | Route 15 (Colombo-Anuradhapura) |

### Private Operators (5)
| Operator ID | Email | Routes Covered |
|-------------|-------|----------------|
| PVT01 | pvt01@private.lk | Route 01 (Colombo-Kandy) |
| PVT02 | pvt02@private.lk | Route 02 (Colombo-Matara) |
| PVT03 | pvt03@private.lk | Route 04 (Colombo-Puttalam) |
| PVT04 | pvt04@private.lk | Route 08 (Colombo-Matale) |
| PVT05 | pvt05@private.lk | Route 15 (Colombo-Anuradhapura) |

## Service Types Distribution

| Service Type | Description | Total Buses | Bus Types |
|--------------|-------------|-------------|-----------|
| N | Normal | 10 buses | Normal |
| LU | Luxury | 10 buses | AC Luxury |
| SE | Semi-Express | 5 buses | Semi-Luxury |

## Sample Fares (LKR)

| Route | Normal (N) | Luxury (LU) | Semi-Express (SE) |
|-------|------------|-------------|-------------------|
| 01 (Colombo-Kandy) | 450.00 | 680.00 | 565.00 |
| 02 (Colombo-Matara) | 520.00 | 780.00 | - |
| 04 (Colombo-Puttalam) | 420.00 | 630.00 | 525.00 |
| 08 (Colombo-Matale) | 485.00 | 728.00 | 606.00 |
| 15 (Colombo-Anuradhapura) | 650.00 | 975.00 | 812.00 |

## Test Credentials

### Admin
- Email: `admin@ntc.gov.lk`
- Password: `adminpass`

### SLTB Operators
- Email: `sltb01@sltb.lk` - `sltb05@sltb.lk`
- Password: `sltb01pass` - `sltb05pass`

### Private Operators
- Email: `pvt01@private.lk` - `pvt05@private.lk`
- Password: `pvt01pass` - `pvt05pass`

### Commuters
- Email: `commuter1@example.com`, `commuter2@example.com`
- Password: `commuterpass`, `commuter2pass`

## API Endpoints Summary

1. **GET /routes** - List all routes with segments
2. **GET /routes/{routeNumber}** - Get specific route (e.g., `/routes/01`)
3. **GET /buses** - List buses with service_type/operator_type filters
4. **GET /routes/{routeNumber}/trips** - List trips with direction/service filters
5. **GET /trips/{tripId}/location** - Get real-time location with segment progress
6. **POST /buses/{busId}/location** - Update location with client-calculated progress data (real-world GPS approach)
7. **GET /routes/{routeNumber}/fares** - Get fares by service type
8. **POST /auth/login** - Authenticate with permit validation support

## Enhanced Location Tracking Features

### Real-World GPS Approach
- **Client-Side Progress Calculation**: GPS devices/mobile apps calculate progress percentages and delay estimates
- **Hybrid Fallback**: Server calculates progress if client data unavailable
- **Enhanced Accuracy**: Real GPS positioning vs time-based estimates
- **Debug Information**: Shows both client-provided and server-calculated values

### Location Update API Parameters
```json
{
  "latitude": 6.9271,
  "longitude": 79.8612,
  "speed_kmh": 45,
  "current_segment_id": 123,           // Optional: Client-calculated current segment
  "segment_progress_percentage": 67.5, // Optional: Progress within current segment (0-100%)
  "total_route_progress_percentage": 34.2, // Optional: Overall route completion (0-100%)
  "estimated_delay_minutes": -3        // Optional: Delay estimate (+ delayed, - ahead)
}
```

## Sample Trips (12 Total)

| Trip ID | Bus ID | Route | Direction | Service | Departure | Arrival | Status |
|---------|--------|-------|-----------|---------|-----------|---------|--------|
| TRIP001 | BUS001 | 01 | outbound | LU | 08:00 | 12:10 | Scheduled |
| TRIP002 | BUS002 | 01 | outbound | SE | 09:00 | 13:10 | Scheduled |
| TRIP003 | BUS003 | 01 | outbound | N | 10:00 | 14:10 | Scheduled |
| TRIP004 | BUS016 | 08 | outbound | LU | 08:30 | 12:30 | Scheduled |
| TRIP005 | BUS017 | 08 | outbound | N | 09:30 | 13:30 | Scheduled |
| TRIP006 | BUS018 | 08 | outbound | SE | 10:30 | 14:30 | Scheduled |
| TRIP007 | BUS006 | 02 | outbound | LU | 07:00 | 11:30 | Scheduled |
| TRIP008 | BUS007 | 02 | outbound | N | 08:00 | 12:30 | Scheduled |
| TRIP009 | BUS011 | 04 | outbound | SE | 07:30 | 11:30 | Scheduled |
| TRIP010 | BUS012 | 04 | outbound | N | 08:30 | 12:30 | Scheduled |
| TRIP011 | BUS021 | 15 | outbound | LU | 06:00 | 11:00 | Scheduled |
| TRIP012 | BUS022 | 15 | outbound | N | 07:00 | 12:00 | Scheduled |

## Database Tables Summary

- **routes** (5 records) - Main route definitions with distance and time
- **route_segments** (13 records total) - Detailed route breakdown by segments
- **buses** (25 records) - Bus fleet with NTC permits and specifications
- **trips** (12 records) - Scheduled trips connecting buses to routes
- **trip_segments** (0 records) - Individual segment progress tracking (populated during trips)
- **locations** (0 records) - Real-time GPS locations (populated during active trips)
- **fares** (15 records) - Fare structure by route and service type
- **users** (13 records in auth middleware) - Authentication data

## Database Schema Overview

### Core Tables with Actual Field Types

#### Routes Table
```sql
CREATE TABLE routes (
    id SERIAL PRIMARY KEY,
    route_number VARCHAR(10) UNIQUE NOT NULL,
    from_city VARCHAR(100) NOT NULL,
    to_city VARCHAR(100) NOT NULL,
    distance_km INTEGER NOT NULL,           -- Integer, not decimal
    estimated_time_hrs FLOAT NOT NULL,      -- Float for fractional hours
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Route Segments Table
```sql
CREATE TABLE route_segments (
    id SERIAL PRIMARY KEY,
    route_id INTEGER NOT NULL REFERENCES routes(id),
    segment_order INTEGER NOT NULL,
    from_location VARCHAR(100) NOT NULL,
    to_location VARCHAR(100) NOT NULL,
    distance_km FLOAT NOT NULL,             -- Float for precise distances
    estimated_time_hrs FLOAT NOT NULL,     -- Float for fractional hours
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(route_id, segment_order)
);
```

#### Buses Table
```sql
CREATE TABLE buses (
    id VARCHAR(10) PRIMARY KEY,
    plate_no VARCHAR(20) UNIQUE NOT NULL,
    permit_number VARCHAR(50) UNIQUE NOT NULL,
    operator_id VARCHAR(20) NOT NULL,
    operator_type VARCHAR(10) NOT NULL CHECK (operator_type IN ('SLTB', 'Private')),
    capacity INTEGER NOT NULL CHECK (capacity > 0),
    service_type VARCHAR(5) NOT NULL CHECK (service_type IN ('N', 'LU', 'SE')),
    type VARCHAR(20) NOT NULL,              -- Bus type: 'AC Luxury', 'Semi-Luxury', 'Normal'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Trips Table
```sql
CREATE TABLE trips (
    id VARCHAR(10) PRIMARY KEY,
    bus_id VARCHAR(10) NOT NULL REFERENCES buses(id),
    route_id INTEGER NOT NULL REFERENCES routes(id),
    direction VARCHAR(10) NOT NULL CHECK (direction IN ('outbound', 'inbound')),
    service_type VARCHAR(5) NOT NULL CHECK (service_type IN ('N', 'LU', 'SE')),
    departure_time TIMESTAMP NOT NULL,
    arrival_time TIMESTAMP NOT NULL,
    interval_min INTEGER,                   -- Interval between trips in minutes
    status VARCHAR(20) NOT NULL CHECK (status IN ('Scheduled', 'In Progress', 'Completed', 'Delayed', 'Cancelled')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Trip Segments Table (Progress Tracking)
```sql
CREATE TABLE trip_segments (
    id SERIAL PRIMARY KEY,
    trip_id VARCHAR(10) NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
    segment_id INTEGER NOT NULL REFERENCES route_segments(id) ON DELETE RESTRICT,
    scheduled_arrival_time TIMESTAMP,
    actual_arrival_time TIMESTAMP,
    progress_percentage FLOAT DEFAULT 0 CHECK (progress_percentage BETWEEN 0 AND 100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Enhanced Locations Table Schema
```sql
CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    trip_id VARCHAR(10) NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
    bus_id VARCHAR(10) NOT NULL REFERENCES buses(id) ON DELETE CASCADE,
    current_segment_id INTEGER REFERENCES route_segments(id),
    latitude FLOAT NOT NULL CHECK (latitude BETWEEN -90 AND 90),
    longitude FLOAT NOT NULL CHECK (longitude BETWEEN -180 AND 180),
    speed_kmh INTEGER NOT NULL CHECK (speed_kmh >= 0),
    segment_progress_percentage FLOAT DEFAULT 0 CHECK (segment_progress_percentage BETWEEN 0 AND 100),
    total_route_progress_percentage FLOAT DEFAULT 0 CHECK (total_route_progress_percentage BETWEEN 0 AND 100),
    estimated_delay_minutes INTEGER DEFAULT 0, -- Positive = delayed, Negative = ahead of schedule
    timestamp TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Fares Table
```sql
CREATE TABLE fares (
    id SERIAL PRIMARY KEY,
    route_id INTEGER NOT NULL REFERENCES routes(id) ON DELETE CASCADE,
    service_type VARCHAR(5) NOT NULL CHECK (service_type IN ('N', 'LU', 'SE')),
    from_segment_id INTEGER NOT NULL REFERENCES route_segments(id),
    to_segment_id INTEGER NOT NULL REFERENCES route_segments(id),
    fare_amount DECIMAL(8,2) NOT NULL CHECK (fare_amount >= 0),
    currency VARCHAR(3) DEFAULT 'LKR',
    effective_date DATE NOT NULL,
    expiry_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Performance Indexes
- `idx_routes_route_number` ON routes (route_number)
- `idx_routes_from_to` ON routes (from_city, to_city)
- `idx_route_segments_route_id` ON route_segments (route_id)
- `idx_buses_operator_id` ON buses (operator_id)
- `idx_buses_permit_number` ON buses (permit_number)
- `idx_buses_service_type` ON buses (service_type)
- `idx_trips_route_id` ON trips (route_id)
- `idx_trips_bus_id` ON trips (bus_id)
- `idx_trips_direction` ON trips (direction)
- `idx_trips_service_type` ON trips (service_type)
- `idx_trips_departure_time` ON trips (departure_time)
- `idx_trip_segments_trip_id` ON trip_segments (trip_id)
- `idx_locations_trip_id` ON locations (trip_id)
- `idx_locations_bus_id` ON locations (bus_id)
- `idx_locations_timestamp` ON locations (timestamp)
- `idx_locations_segment_id` ON locations (current_segment_id)
- `idx_fares_route_service` ON fares (route_id, service_type)

### Automated Triggers
- `update_updated_at_column()` function with triggers on routes, buses, trips, trip_segments, and fares tables

## Data Accuracy & Completeness

✅ **Schema Synchronized**: This documentation now accurately reflects the actual database schema defined in `init.sql`

✅ **Sample Data Verified**: All route numbers, bus IDs, permits, operators, and fare amounts match the database initialization script

✅ **Field Types Documented**: Correct data types (INTEGER vs FLOAT vs VARCHAR) as implemented in PostgreSQL

✅ **Constraints Included**: All CHECK constraints, foreign keys, and unique constraints documented

✅ **Performance Optimized**: 16 database indexes for efficient querying on key fields

✅ **Real-World Ready**: GPS location tracking with client-side progress calculation support

The system is now fully populated with comprehensive test data covering all 5 NTC routes with realistic bus allocations, operator assignments, and fare structures. **Enhanced with real-world GPS location tracking capabilities** supporting both client-calculated and server-calculated progress data.

### Notable Schema Features
- **Route 08 Overlap**: Route 08 (Colombo-Matale) shares segments with Route 01 (Peradeniya-Kadugannawa), enabling overlapping route detection
- **Bidirectional Support**: Trip direction field supports both 'outbound' and 'inbound' journeys
- **Flexible Progress Tracking**: Trip segments table allows detailed progress monitoring per route segment
- **NTC Compliance**: All permit numbers follow NTC2023XXX pattern for regulatory compliance
- **Service Type Alignment**: Bus types (AC Luxury, Semi-Luxury, Normal) align with service types (LU, SE, N)